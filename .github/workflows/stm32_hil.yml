name: stm32_hil

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: stm32-hil
  cancel-in-progress: false

jobs:
  hil:
    runs-on: [self-hosted, windows, stm32]

    steps:
      - name: Mark workspace as safe for git
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          git config --global --add safe.directory "$env:GITHUB_WORKSPACE"
          git config --global --add safe.directory "C:/Users/trina/Documents/actions-runner/_work/LCD_F4/LCD_F4"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup build tools PATH
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          # ARM GCC from STM32CubeIDE install (your exact path)
          $gccBin = "C:\ST\STM32CubeIDE_2.0.0\STM32CubeIDE\plugins\com.st.stm32cube.ide.mcu.externaltools.gnu-tools-for-stm32.13.3.rel1.win32_1.0.100.202509120712\tools\bin"
          if (-not (Test-Path $gccBin)) { throw "GCC bin path not found: $gccBin" }
          Add-Content -Path $env:GITHUB_PATH -Value $gccBin

          # Try to find make inside STM32CubeIDE plugins (works for runner service user too)
          $cubePlugins = "C:\ST\STM32CubeIDE_2.0.0\STM32CubeIDE\plugins"
          if (-not (Test-Path $cubePlugins)) { throw "CubeIDE plugins path not found: $cubePlugins" }

          $mk = Get-ChildItem -Path $cubePlugins -Recurse -Filter "make.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $mk) {
            $mk = Get-ChildItem -Path $cubePlugins -Recurse -Filter "mingw32-make.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          }

          if ($mk) {
            $mkDir = Split-Path $mk.FullName -Parent
            Add-Content -Path $env:GITHUB_PATH -Value $mkDir
            Write-Host "Found make: $($mk.FullName)"
          } else {
            Write-Host "No make.exe found inside CubeIDE plugins; trying common locations..."
          }

          # Common locations (if you later install MSYS2/Git/Chocolatey make)
          $candidates = @(
            "C:\ProgramData\chocolatey\bin",
            "C:\msys64\usr\bin",
            "C:\msys32\usr\bin",
            "C:\Program Files\Git\usr\bin",
            "C:\Program Files\Git\mingw64\bin",
            "C:\Program Files (x86)\GnuWin32\bin"
          )
          foreach ($d in $candidates) {
            if (Test-Path $d) { Add-Content -Path $env:GITHUB_PATH -Value $d }
          }

          # Resolve make command (make or mingw32-make)
          $makeCmd = Get-Command make -ErrorAction SilentlyContinue
          if (-not $makeCmd) { $makeCmd = Get-Command mingw32-make -ErrorAction SilentlyContinue }
          if (-not $makeCmd) { throw "make not found for runner user. Install MSYS2 make or ensure CubeIDE provides make." }

          "MAKE_EXE=$($makeCmd.Source)" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "MAKE_EXE=$($makeCmd.Source)"

      - name: Toolchain sanity check
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          & "$env:MAKE_EXE" --version
          arm-none-eabi-gcc --version
          arm-none-eabi-objcopy --version

      - name: Build firmware (Debug)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          & "$env:MAKE_EXE" -C Debug clean all

      - name: Locate firmware binary
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $bin = Get-ChildItem -Path Debug -Filter *.bin | Select-Object -First 1
          if (-not $bin) { throw "No .bin found in Debug/ after build." }
          "BIN_PATH=$($bin.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Using bin: $($bin.FullName)"

      - name: Flash target
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          ./scripts/flash.ps1 -BinaryPath "$env:BIN_PATH"

      - name: Run UART HIL
        shell: powershell
        env:
          HIL_COM_PORT: "COM4"
          HIL_BAUD: "115200"
          HIL_TIMEOUT_S: "25"
          HIL_LOG_PATH: "hil.log"
        run: |
          $ErrorActionPreference = "Stop"
          ./scripts/hil_smoke_test.ps1

      - name: Upload HIL logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hil-logs
          path: hil.log
