name: stm32_hil

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: stm32-hil
  cancel-in-progress: false

jobs:
  hil:
    runs-on: [self-hosted, windows, stm32]

    steps:
      - name: Mark workspace as safe for git
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          git config --global --add safe.directory "$env:GITHUB_WORKSPACE"
          git config --global --add safe.directory "C:/Users/trina/Documents/actions-runner/_work/LCD_F4/LCD_F4"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup build tools PATH
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          # ARM GCC from your STM32CubeIDE install
          $gccBin = "C:\ST\STM32CubeIDE_2.0.0\STM32CubeIDE\plugins\com.st.stm32cube.ide.mcu.externaltools.gnu-tools-for-stm32.13.3.rel1.win32_1.0.100.202509120712\tools\bin"
          Add-Content -Path $env:GITHUB_PATH -Value $gccBin

          # Common locations where make (and coreutils) may live
          $candidates = @(
            "C:\msys64\usr\bin",
            "C:\msys32\usr\bin",
            "C:\Program Files\Git\usr\bin",
            "C:\Program Files\Git\mingw64\bin",
            "C:\Program Files (x86)\GnuWin32\bin",
            "C:\Strawberry\c\bin"
          )

          foreach ($d in $candidates) {
            if (Test-Path $d) { Add-Content -Path $env:GITHUB_PATH -Value $d }
          }

          # Resolve make command (some installs use mingw32-make)
          $makeCmd = Get-Command make -ErrorAction SilentlyContinue
          if (-not $makeCmd) { $makeCmd = Get-Command mingw32-make -ErrorAction SilentlyContinue }
          if (-not $makeCmd) { throw "make not found. Install MSYS2 (recommended) or add make to PATH for the runner." }

          "MAKE_EXE=$($makeCmd.Source)" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "MAKE_EXE=$($makeCmd.Source)"

      - name: Toolchain sanity check
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          & "$env:MAKE_EXE" --version
          arm-none-eabi-gcc --version
          arm-none-eabi-objcopy --version

      - name: Build firmware (Debug)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          & "$env:MAKE_EXE" -C Debug clean all

      - name: Locate firmware binary
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $bin = Get-ChildItem -Path Debug -Filter *.bin | Select-Object -First 1
          if (-not $bin) { throw "No .bin found in Debug/ after build." }
          "BIN_PATH=$($bin.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Using bin: $($bin.FullName)"

      - name: Flash target
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          ./scripts/flash.ps1 -BinaryPath "$env:BIN_PATH"

      - name: Run UART HIL
        shell: powershell
        env:
          HIL_COM_PORT: "COM4"
          HIL_BAUD: "115200"
          HIL_TIMEOUT_S: "25"
          HIL_LOG_PATH: "hil.log"
        run: |
          $ErrorActionPreference = "Stop"
          ./scripts/hil_smoke_test.ps1

      - name: Upload HIL logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hil-logs
          path: hil.log
