name: stm32_hil

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: stm32-hil
  cancel-in-progress: false

jobs:
  hil:
    runs-on: [self-hosted, windows, stm32]

    steps:
      - name: Mark workspace as safe for git
        shell: powershell
        run: |
          git config --global --add safe.directory "$env:GITHUB_WORKSPACE"
          git config --global --add safe.directory "C:/Users/trina/Documents/actions-runner/_work/LCD_F4/LCD_F4"
          git config --global --list | findstr safe.directory

      - name: Checkout
        uses: actions/checkout@v4

      # REMOVE actions/setup-python@v5 on self-hosted runner
      - name: Verify Python
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          where python
          python --version
          python -m pip --version

      - name: Install Python deps
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          python -m pip install -r scripts/requirements.txt

      - name: Locate firmware binary
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $bin = Get-ChildItem -Path Debug -Filter *.bin | Select-Object -First 1
          if (-not $bin) { throw "No .bin found in Debug/." }
          "BIN_PATH=$($bin.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Using bin: $($bin.FullName)"

      - name: Flash target
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          ./scripts/flash.ps1 -BinaryPath "$env:BIN_PATH"

      - name: Run UART HIL
        env:
          HIL_COM_PORT: "COM4"
          HIL_BAUD: "115200"
          HIL_TIMEOUT_S: "25"
          HIL_LOG_PATH: "hil.log"
        run: |
          python scripts/hil_smoke_test.py

      - name: Upload HIL logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hil-logs
          path: hil.log
